FROM rocker/r-ver:4.5.1

# Set environment variables
ENV R_REMOTES_NO_ERRORS_FROM_WARNINGS=true
ENV RSPM=https://packagemanager.rstudio.com/cran/__linux__/focal/latest
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies and R packages in fewer layers
RUN echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | debconf-set-selections
RUN apt-get update && apt-get install -y \
    git \
    ttf-mscorefonts-installer \
    libcairo2-dev \
    libcurl4-openssl-dev \
    libssl-dev \
    libxml2-dev \
    libudunits2-dev \
    libgdal-dev \
    libgeos-dev \
    libproj-dev \
    libfontconfig1-dev \
    libfreetype6-dev \
    libpng-dev \
    libtiff5-dev \
    libjpeg-dev \
    libglu1-mesa-dev \
    libgl2ps-dev \
    imagemagick \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && R -e "install.packages(c('remotes', 'devtools'))" \
    && R -e "remotes::install_github('r-lib/remotes')" \
    && R -e "if (!require('BiocManager', quietly = TRUE)) install.packages('BiocManager')" \
    && R -e "BiocManager::install(c('genomation', 'genomationData'), update = FALSE)" \
    && R -e "remotes::install_git('https://codeberg.org/hrbrmstr/hrbrthemes.git')" \
    && R -e 'install.packages(c("extrafont","extrafontdb","Rttf2pt1"))' \
    && R -e 'install.packages("tidyverse")' \
    && R -e 'install.packages(c("skimr", "here", "kableExtra", "paletteer"))' \
    && R -e 'install.packages(c("ggsci", "GGally", "RColorBrewer", "ggpubr"))' \
    && R -e 'install.packages(c("multimode", "ggVennDiagram", "tm", "proustr", "VennDiagram", "viridis", "scales", "data.table", "corrplot"))'

# Copy font files
COPY fonts/liberation-fonts-ttf-2.00.1/* /usr/share/fonts/truetype/msttcorefonts/
COPY fonts/*.ttf /usr/share/fonts/truetype/msttcorefonts/
COPY fonts/static/*.ttf /usr/share/fonts/truetype/msttcorefonts/
RUN R -e 'library(extrafont); font_import(prompt=FALSE)'
RUN R -e 'install.packages(c("rgl"))'
# Set working directory
WORKDIR /app

# Copy the docker-compatible script
COPY scripts/GATC_comparison_fin_intragenic.R /app/script.R

# Create directories for data and results
RUN mkdir -p /app/data
RUN mkdir -p /app/results

# Copy data files
COPY data/GATC_data_all_flat_table_weight_av.csv /app/data/
COPY data/ST4-74_mydata_GATC_liftover_strand.bed /app/data/
COPY data/GSE185578_GATC_19_10_25_liftover_strand.bed /app/data/
COPY data/casadeus_undermethyl_liftover_strand.bed /app/data/

# Set the default command to run the script
CMD ["Rscript", "script.R"]
